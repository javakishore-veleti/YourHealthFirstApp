name: "V3 GCP Flask API - Manage"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - destroy
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      region:
        description: 'GCP Region'
        required: true
        default: 'us-central1'
        type: choice
        options:
          - us-central1
          - us-east1
          - us-west1
          - europe-west1

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: healthcare-plans-bo-v3-${{ github.event.inputs.environment }}
  IMAGE_NAME: healthcare-plans-bo-v3
  ARTIFACT_REPO: healthcare-plans-bo
  REGION: ${{ github.event.inputs.region }}
  DB_SECRET_NAME: healthcare-mysql-v3-${{ github.event.inputs.environment }}

jobs:
  # ==================== DEPLOY ====================
  deploy:
    if: github.event.inputs.action == 'deploy'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Check if database exists
        id: check_db
        run: |
          if gcloud secrets describe ${{ env.DB_SECRET_NAME }} --project=${{ env.PROJECT_ID }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Database secret found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Database secret NOT found - run MySQL workflow first!"
          fi

      - name: Fail if database not ready
        if: steps.check_db.outputs.exists == 'false'
        run: |
          echo "::error::Database not found! Please run 'V3 GCP MySQL Database - Manage' workflow first with action 'create'"
          exit 1

      - name: Get database credentials from Secret Manager
        id: db_creds
        run: |
          # Get the secret
          DB_CREDS=$(gcloud secrets versions access latest --secret=${{ env.DB_SECRET_NAME }} --project=${{ env.PROJECT_ID }})
          
          # Parse JSON and set outputs
          echo "db_host=$(echo $DB_CREDS | jq -r '.host')" >> $GITHUB_OUTPUT
          echo "db_port=$(echo $DB_CREDS | jq -r '.port')" >> $GITHUB_OUTPUT
          echo "db_name=$(echo $DB_CREDS | jq -r '.database')" >> $GITHUB_OUTPUT
          echo "db_user=$(echo $DB_CREDS | jq -r '.username')" >> $GITHUB_OUTPUT
          echo "db_password=$(echo $DB_CREDS | jq -r '.password')" >> $GITHUB_OUTPUT
          echo "connection_name=$(echo $DB_CREDS | jq -r '.connection_name')" >> $GITHUB_OUTPUT
          
          # Mask the password
          echo "::add-mask::$(echo $DB_CREDS | jq -r '.password')"

      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:latest"
          
          docker build \
            -f Dockerfile.v3 \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV

      - name: Push Docker image
        run: |
          docker push ${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_LATEST }}

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.IMAGE_TAG }} \
            --platform=managed \
            --region=${{ env.REGION }} \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --port=8080 \
            --set-env-vars="FLASK_ENV=${{ github.event.inputs.environment }}" \
            --set-env-vars="DB_HOST=${{ steps.db_creds.outputs.db_host }}" \
            --set-env-vars="DB_PORT=${{ steps.db_creds.outputs.db_port }}" \
            --set-env-vars="DB_NAME=${{ steps.db_creds.outputs.db_name }}" \
            --set-env-vars="DB_USER=${{ steps.db_creds.outputs.db_user }}" \
            --set-env-vars="DB_PASSWORD=${{ steps.db_creds.outputs.db_password }}" \
            --set-env-vars="CLOUD_SQL_CONNECTION_NAME=${{ steps.db_creds.outputs.connection_name }}" \
            --set-env-vars="JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" \
            --project=${{ env.PROJECT_ID }}
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform=managed \
            --region=${{ env.REGION }} \
            --format='value(status.url)' \
            --project=${{ env.PROJECT_ID }})
          
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Run database migrations
        run: |
          echo "ðŸ”„ Running database migrations..."
          # Trigger migration endpoint or run via Cloud Run job
          curl -X POST "${{ steps.deploy.outputs.service_url }}/api/v3/admin/migrate" \
            -H "Content-Type: application/json" \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            --fail --silent --show-error || echo "Migration endpoint not available, skipping..."

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 10
          
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.service_url }}/api/v3/health" || echo "000")
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "âœ… Health check passed!"
              curl -s "${{ steps.deploy.outputs.service_url }}/api/v3/health" | jq .
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_STATUS - retrying..."
            sleep 5
          done
          
          echo "âš ï¸ Health check did not return 200, but deployment completed"

      - name: Summary
        run: |
          echo "## ðŸš€ Flask V3 API Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service Name | \`${{ env.SERVICE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Database Connection" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Host | \`${{ steps.db_creds.outputs.db_host }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | \`${{ steps.db_creds.outputs.db_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| User | \`${{ steps.db_creds.outputs.db_user }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Health: \`${{ steps.deploy.outputs.service_url }}/api/v3/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- Signup: \`${{ steps.deploy.outputs.service_url }}/api/v3/customers/signup\`" >> $GITHUB_STEP_SUMMARY
          echo "- Login: \`${{ steps.deploy.outputs.service_url }}/api/v3/customers/login\`" >> $GITHUB_STEP_SUMMARY
          echo "- Profile: \`${{ steps.deploy.outputs.service_url }}/api/v3/customers/me\`" >> $GITHUB_STEP_SUMMARY

  # ==================== DESTROY ====================
  destroy:
    if: github.event.inputs.action == 'destroy'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Delete Cloud Run service
        run: |
          if gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} 2>/dev/null; then
            echo "ðŸ—‘ï¸ Deleting Cloud Run service..."
            
            gcloud run services delete ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --quiet
            
            echo "âœ… Cloud Run service deleted"
          else
            echo "â„¹ï¸ Service does not exist"
          fi

      - name: Delete container images
        run: |
          echo "ðŸ—‘ï¸ Cleaning up container images..."
          
          # List and delete all images
          gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }} \
            --format="value(DIGEST)" 2>/dev/null | while read digest; do
            if [ -n "$digest" ]; then
              gcloud artifacts docker images delete \
                "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}@$digest" \
                --quiet --delete-tags 2>/dev/null || true
            fi
          done
          
          echo "âœ… Container images cleaned up"

      - name: Summary
        run: |
          echo "## ðŸ—‘ï¸ Flask V3 API Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | \`${{ env.SERVICE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Note" >> $GITHUB_STEP_SUMMARY
          echo "The MySQL database was NOT deleted. To delete the database, run the **V3 GCP MySQL Database - Manage** workflow with action 'destroy'." >> $GITHUB_STEP_SUMMARY
