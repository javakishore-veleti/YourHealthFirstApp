# GitHub Actions Workflow: Deploy Angular V2 UI to Cloud Run
# Location: .github/workflows/v2-gcp-angular-ui-cloud-run-deploy.yml
#
# This workflow:
# 1. Fetches the Flask V2 Cloud Run URL (must be deployed first)
# 2. Updates environment.prod.ts with the API URL
# 3. Builds and deploys Angular V2 to Cloud Run

name: V2 GCP UI Angular - Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      region:
        description: 'GCP Region'
        required: true
        default: 'us-central1'
        type: choice
        options:
          - us-central1
          - us-east1
          - us-west1
          - europe-west1
          - asia-east1

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ github.event.inputs.region }}
  
  # Angular UI V2 Service
  UI_SERVICE_NAME: healthcare-plans-ui-v2-${{ github.event.inputs.environment }}
  UI_IMAGE_NAME: healthcare-plans-ui-v2
  UI_ARTIFACT_REPO: healthcare-plans-ui
  
  # Flask Backend V2 Service (to fetch URL from)
  BO_SERVICE_NAME: healthcare-plans-bo-v2-${{ github.event.inputs.environment }}

jobs:
  deploy:
    name: Build and Deploy Angular V2 UI
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get Flask V2 Backend URL
        id: backend-url
        run: |
          echo "üîç Fetching Flask V2 Backend URL..."
          
          BACKEND_URL=$(gcloud run services describe ${{ env.BO_SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' 2>/dev/null || echo "")
          
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ùå ERROR: Flask V2 Backend not found!"
            echo ""
            echo "Please deploy Flask V2 first using the workflow:"
            echo "  'V2 GCP Healthcare API - Deploy'"
            echo ""
            echo "Expected service name: ${{ env.BO_SERVICE_NAME }}"
            exit 1
          fi
          
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Flask V2 Backend URL: $BACKEND_URL"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: angular_front_end/healthcare_plans_ui/package-lock.json

      - name: Install Dependencies
        working-directory: ./angular_front_end/healthcare_plans_ui
        run: npm ci

      - name: Update Environment with Backend URL
        working-directory: ./angular_front_end/healthcare_plans_ui
        run: |
          BACKEND_URL="${{ steps.backend-url.outputs.url }}"
          API_URL="${BACKEND_URL}/api/v2"
          
          echo "üìù Updating environment.prod.ts with API URL: $API_URL"
          
          cat > src/environments/environment.prod.ts << EOF
          /**
           * Environment Configuration - Production (Auto-generated)
           * Generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
           * Flask V2 Backend: ${{ env.BO_SERVICE_NAME }}
           */
          export const environment = {
            production: true,
            apiUrl: '${API_URL}',
            appName: 'YourHealthPlans',
            version: '2.0.0'
          };
          EOF
          
          echo "‚úÖ environment.prod.ts updated:"
          cat src/environments/environment.prod.ts

      - name: Build Angular App (Production)
        working-directory: ./angular_front_end/healthcare_plans_ui
        run: |
          npm run build -- --configuration=production
          echo "‚úÖ Angular build complete"
          ls -la dist/

      - name: Create Nginx Config
        working-directory: ./angular_front_end/healthcare_plans_ui
        run: |
          cat > nginx.conf << 'EOF'
          worker_processes auto;
          error_log /var/log/nginx/error.log warn;
          pid /tmp/nginx.pid;
          
          events {
              worker_connections 1024;
          }
          
          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;
              
              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent"';
              
              access_log /var/log/nginx/access.log main;
              
              sendfile on;
              keepalive_timeout 65;
              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
              
              server {
                  listen 8080;
                  server_name _;
                  root /usr/share/nginx/html;
                  index index.html;
                  
                  location / {
                      try_files $uri $uri/ /index.html;
                  }
                  
                  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
                  
                  add_header X-Frame-Options "SAMEORIGIN" always;
                  add_header X-Content-Type-Options "nosniff" always;
              }
          }
          EOF

      - name: Create Dockerfile
        working-directory: ./angular_front_end/healthcare_plans_ui
        run: |
          cat > Dockerfile << 'EOF'
          FROM nginx:alpine
          COPY nginx.conf /etc/nginx/nginx.conf
          COPY dist/ /usr/share/nginx/html/
          EXPOSE 8080
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Docker Image
        working-directory: ./angular_front_end/healthcare_plans_ui
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:latest \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:${{ github.event.inputs.environment }} \
            .

      - name: Push Docker Image to Artifact Registry
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:latest
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:${{ github.event.inputs.environment }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.UI_SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.UI_ARTIFACT_REPO }}/${{ env.UI_IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --port 8080 \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --concurrency 80

      - name: Get Service URL
        id: frontend-url
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.UI_SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "## üöÄ Angular V2 Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ github.event.inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Angular V2 UI** | ${{ steps.frontend-url.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flask V2 API | ${{ steps.backend-url.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### V2 UI Routes" >> $GITHUB_STEP_SUMMARY
          echo "- Home: ${{ steps.frontend-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- Signup: ${{ steps.frontend-url.outputs.url }}/v2/signup" >> $GITHUB_STEP_SUMMARY
          echo "- Login: ${{ steps.frontend-url.outputs.url }}/v2/login" >> $GITHUB_STEP_SUMMARY
          echo "- Profile: ${{ steps.frontend-url.outputs.url }}/v2/profile" >> $GITHUB_STEP_SUMMARY

      - name: Verify Deployment
        run: |
          echo "Testing Angular V2 UI..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.frontend-url.outputs.url }}")
          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Angular V2 UI is responding! (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Angular V2 UI returned HTTP $HTTP_CODE"
          fi
